<!DOCTYPE html>
<html lang="en">

<head>
  <title>Rodger Hammerstien Character Sheet</title>
  <script defer src="alpine.js"></script>
  <link rel="stylesheet" href="/styles/global.css" />
</head>

<body>
  <main x-data>
    <h1>
      <span x-text="$store.d.name"></span>
      <br />
      <span class="h2small" x-html="'Level ' + $store.d.value_of('level')"></span>
    </h1>

    <div class="cards1">
      <table>
        <tbody>
          <tr>
            <td>Health:</td>
            <td x-html="$store.d.value_of('health')+ `/` + $store.d.value_of('max_health')"></td>
          </tr>
          <tr>
            <td>Regen:</td>
            <td x-text="$store.d.value_of('health_regen')"></td>
          </tr>
        </tbody>
      </table>
      <table>
        <tbody>
          <tr>
            <td>Shields:</td>
            <td x-html="$store.d.value_of('shields') + `/` + $store.d.value_of('max_shields')"></td>
          </tr>
          <tr>
            <td>Regen:</td>
            <td x-html="$store.d.value_of('shield_regen')"></td>
          </tr>
        </tbody>
      </table>
      <table>
        <tbody>
          <tr>
            <td>Movement:</td>
            <td x-text="$store.d.movement()"></td>
          </tr>
          <tr>
            <td>Gold:</td>
            <td x-text="$store.d.value_of('gold')"></td>
          </tr>
        </tbody>
      </table>
      <table>
        <tbody>
          <tr>
            <td>BA Rank:</td>
            <td x-text="$store.d.value_of('ba_rank')"></td>
          </tr>
          <tr>
            <td>BA Tokens:</td>
            <td x-text="$store.d.value_of('ba_tokens')"></td>
          </tr>
        </tbody>
      </table>
    </div>


    <h2>Initiative<br>
      <div class="h2small">Natural: <span x-text="$store.d.rolls.initiative_natural">0</span> - Total: <span
          x-text="$store.d.rolls.initiative_total">0</span></div>
    </h2>
    <div class="cards1">
      <table>
        <tbody>
          <tr>
            <td>Speed Mod:</td>
            <td x-html="`+` + $store.d.mod_of('speed')"></td>
          </tr>
          <tr>
            <td>Misc Mod:</td>
            <td x-html="`+` + $store.d.value_of('initiative_mod')"></td>
          </tr>
        </tbody>
      </table>
      <table>
        <tbody>
          <tr>
            <td>BA Rank:</td>
            <td x-html="`+` + $store.d.value_of('ba_rank')"></td>
          </tr>
          <tr>
            <td>1d20</td>
            <td><button class="roller" @click="$store.d.roll_initiative()">Roll</button></td>
          </tr>
        </tbody>
      </table>
    </div>


    <h2>Skill Checks<br>
      <div class="h2small">Natural: <span x-text="$store.d.rolls.checks_natural">0</span>
        - Total: <span x-text="$store.d.rolls.checks_total">0</span>
      </div>
    </h2>
    <div class="cards1">
      <table>
        <tbody>
          <tr>
            <td><button class="roller" @click="$store.d.skill_check($store.d.insight())">Insight:</button></td>
            <td x-text="$store.d.insight()"></td>
          </tr>
          <tr>
            <td><button class="roller" @click="$store.d.skill_check($store.d.interact())">Interact:</button></td>
            <td x-text="$store.d.interact()"></td>
          </tr>
        </tbody>
      </table>
      <table>
        <tbody>
          <tr>
            <td><button class="roller" @click="$store.d.skill_check($store.d.search())">Search:</button></td>
            <td x-text="$store.d.search()"></td>
          </tr>
          <tr>
            <td><button class="roller" @click="$store.d.skill_check($store.d.loot_search())">Loot Search:</button>
            </td>
            <td x-text="$store.d.loot_search()"></td>
          </tr>
        </tbody>
      </table>
      <table>
        <tbody>
          <tr>
            <td><button class="roller" @click="$store.d.skill_check($store.d.sneak())">Sneak:</button></td>
            <td x-text="$store.d.sneak()"></td>
          </tr>
          <tr>
            <td><button class="roller" @click="$store.d.skill_check($store.d.guild_sneak())">Guild Sneak:</button>
            </td>
            <td x-text="$store.d.guild_sneak()"></td>
          </tr>
        </tbody>
      </table>
      <table>
        <tbody>
          <tr>
            <td><button class="roller" @click="$store.d.skill_check($store.d.talk())">Talk:</button></td>
            <td x-text="$store.d.talk()"></td>
          </tr>
          <tr>
            <td><button class="roller" @click="$store.d.skill_check($store.d.traverse())">Traverse:</button></td>
            <td x-text="$store.d.traverse()"></td>
          </tr>
        </tbody>
      </table>
    </div>


  </main>

  <script>
    document.addEventListener('alpine:init', () => {
      Alpine.store('d', {

        // checks
        insight() {
          return this.mod_of('accuracy') + this.value_of('insight_mod')
        },
        interact() {
          return this.mod_of('accuracy') + this.value_of('interact_mod')
        },
        search() {
          return this.mod_of('mastery') + this.value_of('search_mod')
        },
        loot_search() {
          return this.value_of('loot_search') + this.search()
        },
        sneak() {
          return this.mod_of('mastery') + this.value_of('sneak_mod')
        },
        guild_sneak() {
          return this.value_of('guild_sneak') + this.sneak()
        },
        talk() {
          return this.mod_of('speed') + this.value_of('talk_mod')
        },
        traverse() {
          return this.mod_of('speed') + this.value_of('traverse_mod')
        },

        mod_of(id) {
          return Math.floor(this.value_of(id) / 2)
        },

        movement() {
          return this.value_of("movement_base") +
            this.mod_of("speed") +
            this.mod_of("movement_mod")
        },

        roll(sides) {
          const roll_holder = new Uint32Array(1)
          crypto.getRandomValues(roll_holder)
          const raw_roll = roll_holder[0] / (0xffffffff + 1)
          return Math.floor(raw_roll * parseInt(sides, 10)) + 1
        },

        roll_initiative() {
          this.rolls.initiative_natural = this.roll(20)
          this.rolls.initiative_total =
            this.rolls.initiative_natural +
            this.value_of('ba_rank') +
            this.mod_of('speed') +
            this.value_of('initiative_mod')
        },

        skill_check(mod) {
          this.rolls.checks_natural = this.roll(20)
          this.rolls.checks_total = this.rolls.checks_natural + mod
        },

        value_of(id) {
          let holder = []
          for (let k of Object.keys(this.stats)) {
            this.stats[k].stats.forEach((s) => {
              if (s.k === id) {
                holder.push(s.v)
              }
            })
          }
          return holder.reduce((a, c) => a + c, 0);
        },



        name: "Rodger Hammerstien",

        rolls: {
          checks_natural: "",
          checks_total: "",
          initiative_natural: "",
          initiative_total: "",
        },

        stats: {
          character: {
            name: "Character Details",
            stats: [
              {k: "ba_rank", v: 1},
              {k: "ba_tokens", v: 0},
              {k: "gold", v: 113},
              {k: "health", v: 14},
              {k: "health_regen", v: 0},
              {k: "level", v: 1},
              {k: "max_health", v: 14},
              {k: "max_shields", v: 20},
              {k: "melee_die", v: 4},
              {k: "movement_base", v: 3},
              {k: "shields", v: 20},
              {k: "shield_regen", v: 5},
            ]
          },
          archetype: {
            name: "Archetype: Deadeye",
            stats: [
              {k: "accuracy", v: 4},
              {k: "damage", v: 1},
              {k: "mastery", v: 2},
              {k: "speed", v: 0},
            ]
          },

          background: {
            name: "Background: Prize Shot",
            stats: [
              {k: "accuracy", v: 2},
              {k: "insight_mod", v: -2}
            ]
          },
          caliber1: {
            name: "Skill Tree: Caliber Level 1",
            stats: [
              {k: "damage_mod_favored_gun", v: 1},
              {k: "search_mod", v: 1},
            ]
          },
          class: {
            name: "Class: Hunter",
            stats: [
              {k: "accuracy", v: 2},
              {k: "damage", v: 1},
              {k: "mastery", v: 1},
              {k: "speed", v: 0},
            ]
          },
          insider: {
            name: "Insider Trait",
            stats: [
              {k: "loot_search", v: 5},
            ]
          },
          looter: {
            name: "Looter Trait",
            stats: [
              {k: "guild_sneak", v: 5},
            ]
          },
          skill_points: {
            name: "Skill Points",
            stats: [
              {k: "accuracy", v: 0},
              {k: "damage", v: 0},
              {k: "mastery", v: 0},
              {k: "speed", v: 0},
            ]
          }
        },

      })

    })
  </script>
</body>

</html>
