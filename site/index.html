<!DOCTYPE html>
<html lang="en">

<head>
  <title>Rodger Hammerstien Character Sheet</title>
  <script defer src="alpine.js"></script>
  <link rel="stylesheet" href="/styles/global.css" />
</head>

<body>
  <main x-data>
    <h1>
      <span x-text="$store.d.name"></span>
      <br />
      <span class="h2small" x-html="'Level ' + $store.d.level"></span>
    </h1>

    <div class="cards1">
      <table>
        <tbody>
          <tr>
            <td>Health:</td>
            <td x-html="$store.d.health.current + `/` + $store.d.health.max"></td>
          </tr>
          <tr>
            <td>Regen:</td>
            <td x-text="$store.d.health.regen"></td>
          </tr>
        </tbody>
      </table>
      <table>
        <tbody>
          <tr>
            <td>Shields:</td>
            <td x-html="$store.d.shields.current + `/` + $store.d.shields.max"></td>
          </tr>
          <tr>
            <td>Regen:</td>
            <td x-html="$store.d.shields.regen"></td>
          </tr>
        </tbody>
      </table>
      <table>
        <tbody>
          <tr>
            <td>Movement:</td>
            <td x-text="$store.d.movement"></td>
          </tr>
          <tr>
            <td>Gold:</td>
            <td x-text="$store.d.gold"></td>
          </tr>
        </tbody>
      </table>
      <table>
        <tbody>
          <tr>
            <td>BA Rank:</td>
            <td x-text="$store.d.ba_rank"></td>
          </tr>
          <tr>
            <td>BA Tokens:</td>
            <td x-text="$store.d.ba_tokens"></td>
          </tr>
        </tbody>
      </table>
    </div>


    <h2>Initiative<br>
      <div class="h2small">Natural: <span x-text="$store.d.rolls.initiative_natural">0</span> - Total: <span
          x-text="$store.d.rolls.initiative_total">0</span></div>
    </h2>
    <div class="cards1">
      <table>
        <tbody>
          <tr>
            <td>Speed Mod:</td>
            <td x-html="`+` + $store.d.stat_value('Speed')"></td>
          </tr>
          <tr>
            <td>Misc Mod:</td>
            <td x-html="`+` + $store.d.stat_value('Initiative_Mod')"></td>
          </tr>
        </tbody>
      </table>
      <table>
        <tbody>
          <tr>
            <td>BA Rank:</td>
            <td x-html="`+` + $store.d.ba_rank"></td>
          </tr>
          <tr>
            <td>1d20</td>
            <td><button class="roller" @click="$store.d.roll_initiative()">Roll</button></td>
          </tr>
        </tbody>
      </table>
    </div>

    <h2>Skill Checks<br>
      <div class="h2small">Natural: <span x-text="$store.d.rolls.checks_natural">0</span>
        - Total: <span x-text="$store.d.rolls.checks_total">0</span>
      </div>
    </h2>
    <div class="cards1">
      <table>
        <tbody>
          <tr>
            <td><button class="roller" @click="$store.d.skill_check($store.d.check_insight())">Insight:</button></td>
            <td x-text="$store.d.check_insight()"></td>
          </tr>
          <tr>
            <td><button class="roller" @click="$store.d.skill_check($store.d.check_interact())">Interact:</button></td>
            <td x-text="$store.d.check_interact()"></td>
          </tr>
        </tbody>
      </table>
      <table>
        <tbody>
          <tr>
            <td><button class="roller" @click="$store.d.skill_check($store.d.check_search())">Search:</button></td>
            <td x-text="$store.d.check_search()"></td>
          </tr>
          <tr>
            <td><button class="roller" @click="$store.d.skill_check($store.d.check_search_loot())">Loot Search:</button>
            </td>
            <td x-text="$store.d.check_search_loot()"></td>
          </tr>
        </tbody>
      </table>
      <table>
        <tbody>
          <tr>
            <td><button class="roller" @click="$store.d.skill_check($store.d.check_sneak())">Sneak:</button></td>
            <td x-text="$store.d.check_sneak()"></td>
          </tr>
          <tr>
            <td><button class="roller" @click="$store.d.skill_check($store.d.check_sneak_guild())">Guild Sneak:</button>
            </td>
            <td x-text="$store.d.check_sneak_guild()"></td>
          </tr>
        </tbody>
      </table>
      <table>
        <tbody>
          <tr>
            <td><button class="roller" @click="$store.d.skill_check($store.d.check_talk())">Talk:</button></td>
            <td x-text="$store.d.check_talk()"></td>
          </tr>
          <tr>
            <td><button class="roller" @click="$store.d.skill_check($store.d.check_traverse())">Traverse:</button></td>
            <td x-text="$store.d.check_traverse()"></td>
          </tr>
        </tbody>
      </table>
    </div>


    <h2>Basic Rolls<br>
      <div class="h2small">
        Natural:
        <span x-text="$store.d.rolls.basic"></span>
      </div>
    </h2>
    <div class="cards1">
      <table>
        <tbody>
          <tr>
            <td><button class="roller" @click="$store.d.basic_roll(4)">1d4</button></td>
          </tr>
        </tbody>
      </table>
      <table>
        <tbody>
          <tr>
            <td><button class="roller" @click="$store.d.basic_roll(6)">1d6</button></td>
          </tr>
        </tbody>
      </table>
      <table>
        <tbody>
          <tr>
            <td><button class="roller" @click="$store.d.basic_roll(8)">1d8</button></td>
          </tr>
        </tbody>
      </table>
      <table>
        <tbody>
          <tr>
            <td><button class="roller" @click="$store.d.basic_roll(10)">1d10</button></td>
          </tr>
        </tbody>
      </table>
      <table>
        <tbody>
          <tr>
            <td><button class="roller" @click="$store.d.basic_roll(12)">1d12</button></td>
          </tr>
        </tbody>
      </table>
      <table>
        <tbody>
          <tr>
            <td><button class="roller" @click="$store.d.basic_roll(20)">1d20</button></td>
          </tr>
        </tbody>
      </table>
    </div>

    <h2>Range Attack<br>
      <div class="h2small">
        Damage:
        <span x-text="$store.d.ranged_attack.total_damage"></span>
      </div>
    </h2>
    <div class="cards2">
      <table>
        <tbody>
          <tr>
            <td>Accuracy (d20):</td>
            <td x-text="$store.d.ranged_attack.accuracy_natural"></td>
          </tr>
          <tr>
            <td>Modifier:</td>
            <td x-text="$store.d.ranged_attack.accuracy_mod"></td>
          </tr>
          <tr>
            <td>Calculated:</td>
            <td x-text="$store.d.ranged_attack.accuracy_calculated"></td>
          </tr>
        </tbody>
      </table>
      <table>
        <tbody>
          <tr>
            <td>Hits:</td>
            <td x-text="$store.d.ranged_attack.hits"></td>
          </tr>
          <tr>
            <td>Roll:</td>
            <td x-text="$store.d.ranged_attack.hits_roll"></td>
          </tr>
        </tbody>
      </table>
      <table>
        <tbody>
          <tr>
            <td>Crits:</td>
            <td x-text="$store.d.ranged_attack.crits"></td>
          </tr>
          <tr>
            <td>Roll:</td>
            <td x-text="$store.d.ranged_attack.crits_roll"></td>
          </tr>
        </tbody>
      </table>
      <table>
        <tbody>
          <tr>
            <td>FavGun DMG:</td>
            <td></td>
          </tr>
          <tr>
            <td>Bonuses:</td>
            <td></td>
          </tr>
        </tbody>
      </table>
    </div>

    <h2>Guns!</h2>
    <div class="cards3">
      <template x-for="(gun, gun_index) in $store.d.guns">
        <table>
          <tbody>
            <tr>
              <th colspan="2" x-text="gun.name"></th>
            </tr>
            <tr>
              <td x-html="`From ` + gun.guild"></td>
              <td><button @click="$store.d.roll_ranged_attack(gun_index)">Roll</button></td>
            </tr>
            <tr>
              <td>Type</td>
              <td x-text="gun.type"></td>
            </tr>
            <tr>
              <td>Favored</td>
              <td x-text="$store.d.is_favored_gun_type(gun_index)"></td>
            </tr>
            <tr>
              <td>Range</td>
              <td x-text="gun.range"></td>
            </tr>
            <tr>
              <td>Damage</td>
              <td x-text="gun.damage.map((d) => { return ` d` + d })"></td>
            </tr>
            <template x-for="stat in gun.stats">
              <tr>
                <td x-text="stat.name"></td>
                <td x-html="`+` + stat.value"></td>
              </tr>
            </template>
            <template x-for="toggle_key in Object.keys(gun.toggles)">
              <template x-for="toggle, toggle_index in gun.toggles[toggle_key]">
                <tr>
                  <td x-text="toggle.desc"></td>
                  <td><input x-on:change="$store.d.change_gun_toggle(gun_index, toggle_key, toggle_index)"
                      type="checkbox" checked></td>
                </tr>
              </template>
            </template>
            <template x-for="hit in gun.hits">
              <tr>
                <td>Add 1 hit at:</td>
                <td x-text="hit.min_roll"></td>
              </tr>
            </template>
            <template x-for="crit in gun.crits">
              <tr>
                <td>Add 1 crit at:</td>
                <td x-text="crit.min_roll"></td>
              </tr>
            </template>
          </tbody>
        </table>
      </template>
    </div>


    <!--


    <h2>Melee Attack
      <div class="h2small">
        Damage:
        <span id="Melee_Damage">0</span>
      </div>
    </h2>

    <div class="cards1">
      <table>
        <tbody>
          <tr>
            <td>1d4</td>
            <td><button class="melee_roller" data-value="4">Roll</button></td>
          </tr>
          <tr>
            <td>Natural:</td>
            <td id="Melee_Natural">0</td>
          </tr>
          <tr>
            <td>
              Mod:</td>
            <td id="Melee_Mod" class="plus">1</td>
          </tr>
        </tbody>
      </table>
    </div>

-->


    <h2>Base Stats</h2>
    <div class="cards1">
      <template x-for="stat_name in $store.d.stat_names">
        <table>
          <tr>
            <td x-text="stat_name"></td>
            <td x-text="$store.d.stat_value(stat_name)"></td>
          </tr>
          <tr>
            <td>Mod</td>
            <td x-text="$store.d.stat_mod(stat_name)"></td>
          </tr>
        </table>
      </template>
    </div>

    <template x-for="stat_category in $store.d.stat_categories">
      <div>
        <h2 x-text="stat_category[0]"></h2>
        <div class="cards1">
          <template x-for="stat_name in $store.d.stat_names">
            <table>
              <tr>
                <td x-text="stat_name"></td>
                <td x-text="$store.d.stat_values[stat_name][stat_category[1]]"></td>
              </tr>
            </table>
          </template>
        </div>
      </div>
    </template>
  </main>

  <script>
    document.addEventListener('alpine:init', () => {
      Alpine.store('d', {

        ba_rank: 1,
        ba_tokens: 0,
        gold: 113,
        level: 1,
        movement: 3,
        name: "Rodger Hammerstein",

        favored_guns: ["Sniper"],

        guns: [
          {
            damage: [10],
            guild: "Black Powder",
            name: "Crappy Sniper",
            range: 8,
            type: "Sniper",
            crits: [
              {min_roll: 16, add: 1}
            ],
            hits: [
              {min_roll: 8, add: 1}
            ],
            stats: {
              Accuracy: {name: "Accuracy", value: 2},
              Crit_Damage: {name: "Crit Damage", value: 2}
            },
            toggles: {
              Accuracy: [
                {desc: "Range 3 = ACC +3", status: true, value: 3}
              ]
            },
          },

          {
            damage: [4, 4],
            guild: "Alas!",
            name: "Synergy",
            range: 5,
            type: "Pistol",
            crits: [],
            hits: [
              {min_roll: 2, add: 1},
              {min_roll: 8, add: 1},
              {min_roll: 16, add: 1}
            ],
            stats: {
              Damage: {name: "Damage", value: 1}
            },
            toggles: []
          }

        ],

        health: {
          max: 14,
          current: 14,
          regen: 0
        },

        ranged_attack: {
          accuracy_natural: 0,
          accuracy_mod: 0,
          accuracy_calculated: 0,
          total_damage: 0,
        },

        rolls: {
          basic: 0,
          checks_natural: 0,
          checks_total: 0,
          initiative_natural: 0,
          initiative_total: 0,
        },

        stat_values: {
          Accuracy: {
            archetype: 4,
            background: 1,
            class: 2,
            skill_points: 0,
          },
          Damage: {
            archetype: 1,
            class: 2,
            skill_points: 0,
          },
          Damage_Mod_Favored_Gun: {
            caliber_level_1: 1
          },
          Guild_Sneak_Mod: {
            looter_trait: 5
          },
          Insight_Mod: {
            background: -2,
          },
          Interact_Mod: {},
          Initiative_Mod: {},
          Loot_Search_Mod: {
            insider_trait: 5
          },
          Mastery: {
            archetype: 2,
            class: 1,
            skill_points: 0,
          },
          Search_Mod: {
            caliber_level_1: 1
          },
          Sneak_Mod: {},
          Speed: {
            archetype: 0,
            class: 0,
            skill_points: 0,
          },
          Talk_Mod: {},
          Traverse_Mod: {},
        },

        shields: {
          max: 20,
          current: 20,
          regen: 5,
          type: "Basic",
          info: "Just a regular old shield that saves your ass"
        },

        stat_categories: [
          ["Skill Points", "skill_points"],
          ["Archetype: Deadeye", "archetype"],
          ["Class: Hunter", "class"],
        ],

        stat_names: ['Accuracy', 'Damage', 'Mastery', 'Speed'],

        traits: [
          {name: "Insider", desc: "+5 Loot Search Checks"},
          {name: "Looter", desc: "+5 Guild Sneak Checks"},
        ],

        basic_roll(sides) {
          this.rolls.basic = this.roll(sides)
        },

        change_gun_toggle(gun_index, toggle_key, toggle_index) {
          this.guns[gun_index].toggles[toggle_key][toggle_index].status = !
            this.guns[gun_index].toggles[toggle_key][toggle_index].status
        },

        check_insight() {
          return this.stat_mod("Accuracy") + this.stat_value("Insight_Mod")
        },
        check_interact() {
          return this.stat_mod("Accuracy") + this.stat_value("Interact_Mod")
        },
        check_search() {
          return this.stat_mod("Mastery") + this.stat_value("Search_Mod")
        },
        check_search_loot() {
          return this.check_search() + this.stat_value("Loot_Search_Mod")
        },
        check_sneak() {
          return this.stat_mod("Mastery") + this.stat_value("Sneak_Mod")
        },
        check_sneak_guild() {
          return this.check_sneak() + this.stat_value("Guild_Sneak_Mod")
        },
        check_talk() {
          return this.stat_mod("Speed") + this.stat_value("Talk_Mod")
        },
        check_traverse() {
          return this.stat_mod("Speed") + this.stat_value("Traverse_Mod")
        },

        is_favored_gun_type(index) {
          if (this.favored_guns.includes(this.guns[index].type)) {
            return true
          } else {
            return false
          }
        },

        roll(sides) {
          // Includes parseInt so you don't have to do it elsewhere
          const roll_holder = new Uint32Array(1)
          crypto.getRandomValues(roll_holder)
          const raw_roll = roll_holder[0] / (0xffffffff + 1)
          return Math.floor(raw_roll * parseInt(sides, 10)) + 1
        },

        roll_ranged_attack(index) {
          const gun = this.guns[index]
          const ra = this.ranged_attack
          ra.accuracy_natural = this.roll(20)
          ra.accuracy_mod = 0

          if (this.is_favored_gun_type(index)) {
            ra.accuracy_mod += this.stat_mod('Accuracy')
          }

          if (gun.stats.Accuracy) {
            ra.accuracy_mod += gun.stats.Accuracy.value
          }

          if (gun.toggles.Accuracy) {
            gun.toggles.Accuracy.forEach((toggle) => {
              if (toggle.status === true) {
                ra.accuracy_mod += toggle.value
              }
            })
          }

          ra.accuracy_calculated = ra.accuracy_natural + ra.accuracy_mod

          if (ra.accuracy_natural === 1) {
            ra.accuracy_mod = 0
            ra.accuracy_calculated = 0
          }

          ra.hits = 0
          gun.hits.forEach((hit) => {
            if (ra.accuracy_calculated >= hit.min_roll) {
              ra.hits += 1
            }
          })

          ra.crits = 0
          gun.crits.forEach((crit) => {
            if (ra.accuracy_calculated >= crit.min_roll) {
              ra.crits += 1
            }
          })






          // this.ranged_attack.total_damage = 'x'
        },

        roll_initiative() {
          this.rolls.initiative_natural = this.roll(20)
          this.rolls.initiative_total =
            this.rolls.initiative_natural +
            this.ba_rank +
            this.stat_mod("Speed") +
            this.stat_value('Initiative_Mod')
        },

        skill_check(mod) {
          this.rolls.checks_natural = this.roll(20)
          this.rolls.checks_total = this.rolls.checks_natural + mod
        },

        stat_value(name) {
          return Object.entries(this.stat_values[name]).map((k) => {
            return k[1]
          }).reduce((accumulator, currentValue) => accumulator + currentValue, 0)
        },

        stat_mod(name) {
          return Math.floor(this.stat_value(name) / 2)
        },

      })
    })
  </script>
</body>

</html>
