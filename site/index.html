<!DOCTYPE html>
<html>

<head>
  <title>Rodger Roller</title>
  <style>
    body {
      background-color: black;
      color: #aaa;
    }
  </style>
  <link rel="stylesheet" href="/styles/global.css" />
  <script>
    const s = {
      base_stats: ["Accuracy", "Damage", "Mastery", "Speed"],
    }

    const updateState = () => {
      for (k in s) {
        if (window[k] !== undefined) {
          window[k].innerHTML = s[k]
        }
      }
    }

    const roll = (sides) => {
      const roll_holder = new Uint32Array(1)
      crypto.getRandomValues(roll_holder)
      const raw_roll = roll_holder[0] / (0xffffffff + 1)
      return Math.floor(raw_roll * sides) + 1
    }

    const get_stat_total = (class_name) => {
      return Array.from(
        document.getElementsByClassName(class_name)
      ).map((element) => {
        return parseInt(element.innerHTML, 10)
      }).reduce((accumulator, currentValue) => accumulator + currentValue, 0)
    }

    const get_toggle_total = (class_name) => {
      return Array.from(
        document.getElementsByClassName(class_name)
      ).map((element) => {
        if (element.checked) {
          return parseInt(element.dataset.value, 10)
        }
        else {
          return 0
        }
      }).reduce((accumulator, currentValue) => accumulator + currentValue, 0)
    }

    const get_min_total = (class_name, compare_value) => {
      return Array.from(
        document.getElementsByClassName(class_name)
      ).map((element) => {
        if (compare_value >= parseInt(element.dataset.min, 10)) {
          return parseInt(element.dataset.value, 10)
        }
        else {
          return 0
        }
      }).reduce((accumulator, currentValue) => accumulator + currentValue, 0)
    }

    const updateValues = () => {
      s.base_stats.forEach((stat) => {
        s[`${stat}_Base`] = get_stat_total(stat)
        s[`${stat}_Mod`] = Math.floor(get_stat_total(stat) / 2)
      })
    }

    const roll_accuracy = (event) => {
      s.Gun_Number = parseInt(event.target.dataset.gun, 10)
      s.Gun_Accuracy_Mod = get_stat_total(`Gun_Accuracy_Mod__gun${s.Gun_Number}`)
      s.Toggled_Accuracy = get_toggle_total(`Gun_Accuracy_Mod__gun${s.Gun_Number}_toggle`)
      s.Accuracy_Adjustment = s.Gun_Accuracy_Mod + s.Toggled_Accuracy
      s.Is_Favored_Gun_Type = document.getElementById(`Is_Favored_Gun_Type__gun${s.Gun_Number}`).innerHTML
      if (s.Is_Favored_Gun_Type === "yes") {
        s.Accuracy_Adjustment += s.Accuracy_Mod
      }
      s.Roll_Natural = roll(20)
      s.Roll_Total = s.Roll_Natural + s.Accuracy_Adjustment
      if (s.Roll_Natural == 1) {
        s.Hits = 0
        s.Crits = 0
      } else {
        s.Hits = get_min_total(`hits_count_gun${s.Gun_Number}`, s.Roll_Total)
        s.Crits = get_min_total(`crits_count_gun${s.Gun_Number}`, s.Roll_Total)
      }
      if (s.Roll_Natural == 20) {
        s.Crits += 1
      }
      calculate_hits()
    }

    const calculate_hits = () => {
      s.Damage_Bonuses = 0

      if (s.Is_Favored_Gun_Type === "yes") {
        s.Favored_Gun_Damage_Mod = s.Damage_Mod
        s.Damage_Bonuses += get_stat_total(`Damage_Mod_Favored`)
      } else {
        s.Favored_Gun_Damage_Mod = 0
      }

      s.Damage_Bonuses += get_stat_total(`Gun_Damage_Mod__gun${s.Gun_Number}`)

      let natural_hit_rolls = []
      for (let i = 0; i < s.Hits; i++) {
        natural_hit_rolls.push(...Array.from(
          document.getElementsByClassName(`DamageDie__gun${s.Gun_Number}`)
        ).map((element) => {
          return roll(parseInt(element.innerHTML, 10))
        }))
      }

      if (natural_hit_rolls.length === 0) {
        s.Natural_Hit_Rolls = 0
      } else {
        s.Natural_Hit_Rolls = natural_hit_rolls
      }

      let natural_crit_rolls = []
      for (let i = 0; i < s.Crits; i++) {
        natural_crit_rolls.push(roll(12))
      }

      if (natural_crit_rolls.length === 0) {
        s.Natural_Crit_Rolls = 0
      } else {
        s.Natural_Crit_Rolls = natural_crit_rolls
      }

      if (natural_crit_rolls.length > 0) {
        s.Damage_Bonuses += get_stat_total(`Gun_Crit_Damage_Mod__gun${s.Gun_Number}`)
      }

      if (s.Roll_Natural === 1) {
        s.Damage_Bonuses = 0
        s.Favored_Gun_Damage_Mod = 0
      }

      if (s.Hits === 0) {
        s.Damage_Bonuses = 0
        s.Favored_Gun_Damage_Mod = 0
      }

      s.Total_Damage = natural_hit_rolls.reduce((a, c) => a + c, 0) +
        natural_crit_rolls.reduce((a, c) => a + c, 0) +
        s.Damage_Bonuses + s.Favored_Gun_Damage_Mod

      updateState()
    }

    const init = () => {
      Array.from(
        document.getElementsByClassName('accuracy_roller')
      ).forEach((element) => {
        element.addEventListener('click', roll_accuracy)
      })
      updateValues()
      updateState()
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</head>

<body>
  <main>
    <h1>Rodger Roller</h1>
    <div class="cards1">
      <table>
        <tr>
          <td>Level:</td>
          <td>1</td>
        </tr>
        <tr>
          <td>BA Rank:</td>
          <td>1</td>
        </tr>
      </table>

      <table>
        <tr>
          <td>Health:</td>
          <td>14/14</td>
        </tr>
        <tr>
          <td>Regen:</td>
          <td>0</td>
        </tr>
      </table>

      <table>
        <tr>
          <td>Shields:</td>
          <td>20/20</td>
        </tr>
        <tr>
          <td>Regen:</td>
          <td>5</td>
        </tr>
      </table>

      <table>
        <tr>
          <td>Gold:</td>
          <td>113</td>
        </tr>
        <tr>
          <td>BA Tokens:</td>
          <td>0</td>
        </tr>
      </table>
    </div>
    <h2>Range Attack</h2>
    <div class="cards1">
      <table>
        <tr>
          <td>Natural:</td>
          <td id="Roll_Natural">-</td>
        </tr>
        <tr>
          <td>Modifier:</td>
          <td id="Accuracy_Adjustment">-</td>
        </tr>
        <tr>
          <td>Total: </td>
          <td id="Roll_Total">-</td>
        </tr>
      </table>
      <table>
        <tr>
          <td>Number Of Hits: </td>
          <td id="Hits">-</td>
        </tr>
        <tr>
          <td>Number Of Crits: </td>
          <td id="Crits">-</td>
        </tr>
      </table>
      <table>
        <tr>
          <td>Hit Rolls:</td>
          <td id="Natural_Hit_Rolls">-</td>
        </tr>
        <tr>
          <td>Crit Rolls:</td>
          <td id="Natural_Crit_Rolls">-</td>
        </tr>
        <tr>
          <td>FavGun DMG:</td>
          <td id="Favored_Gun_Damage_Mod">-</td>
        </tr>
        <tr>
          <td>Bonuses:</td>
          <td id="Damage_Bonuses">-</td>
        </tr>
      </table>
      <table>
        <tr>
          <td>Total Damage: </td>
          <td id="Total_Damage">-</td>
        </tr>
      </table>
    </div>

    <h2>Guns!</h2>
    <div class="cards3">
      
      <table class="gun_details">
        
        <tr>
          <td colspan="2">Black Powder Guild</td>
        </tr>
        <tr>
          <td><strong>Crappy Sniper</strong></td>
          <td>
            <button class="accuracy_roller" data-gun="0">Roll</button>
          </td>
        </tr>
        <tr>
          <td>Type:</td>
          <td id="Gun_Type_gun0">Sniper</td>
        </tr>
        <tr>
          <td>Favored:</td>
          <td id="Is_Favored_Gun_Type__gun0">yes</td>
        </tr>
        <tr>
          <td>Range: </td>
          <td>8</td>
        </tr>
        
        <tr>
          <td>Damage Die:</td>
          <td class="DamageDie__gun0">10</td>
        </tr>
        
        
        <tr>
          <td>Gun_Accuracy_Mod:</td>
          <td class="Gun_Accuracy_Mod__gun0">2</td>
        </tr>
        
        <tr>
          <td>Gun_Crit_Damage_Mod:</td>
          <td class="Gun_Crit_Damage_Mod__gun0">2</td>
        </tr>
        

        
        <tr>
          <td>Range 3 = ACC +3</td>
          <td><input type="checkbox" class="Gun_Accuracy_Mod__gun0_toggle" data-value="3"
              checked>
          </td>
        </tr>
        

        
        <tr>
          <td class="hits_count_gun0" data-min="8" data-value="1">Add
            1 hit at:
          </td>
          <td>
            8
          </td>
        </tr>
        

        
        <tr>
          <td class="crits_count_gun0" data-min="16" data-value="1">
            Add 1 crit at:
          </td>
          <td>
            16
          </td>
        </tr>
        
      </table>
      
      <table class="gun_details">
        
        <tr>
          <td colspan="2">Alas! Guild</td>
        </tr>
        <tr>
          <td><strong>Synergy</strong></td>
          <td>
            <button class="accuracy_roller" data-gun="1">Roll</button>
          </td>
        </tr>
        <tr>
          <td>Type:</td>
          <td id="Gun_Type_gun1">Pistol</td>
        </tr>
        <tr>
          <td>Favored:</td>
          <td id="Is_Favored_Gun_Type__gun1">no</td>
        </tr>
        <tr>
          <td>Range: </td>
          <td>5</td>
        </tr>
        
        <tr>
          <td>Damage Die:</td>
          <td class="DamageDie__gun1">4</td>
        </tr>
        
        <tr>
          <td>Damage Die:</td>
          <td class="DamageDie__gun1">4</td>
        </tr>
        
        
        <tr>
          <td>Gun_Damage_Mod:</td>
          <td class="Gun_Damage_Mod__gun1">1</td>
        </tr>
        

        

        
        <tr>
          <td class="hits_count_gun1" data-min="2" data-value="1">Add
            1 hit at:
          </td>
          <td>
            2
          </td>
        </tr>
        
        <tr>
          <td class="hits_count_gun1" data-min="8" data-value="1">Add
            1 hit at:
          </td>
          <td>
            8
          </td>
        </tr>
        
        <tr>
          <td class="hits_count_gun1" data-min="16" data-value="1">Add
            1 hit at:
          </td>
          <td>
            16
          </td>
        </tr>
        

        
      </table>
      
    </div>

    <h2>Base Stats</h2>
    <div class="cards2">
      <table>
        <tr>
          <td>Accuracy: </td>
          <td id="Accuracy_Base"></td>
        </tr>
        <tr>
          <td>Mod:</td>
          <td id="Accuracy_Mod"></td>
        </tr>
      </table>
      <table>
        <tr>
          <td>Damage: </td>
          <td id="Damage_Base"></td>
        </tr>
        <tr>
          <td>Mod:</td>
          <td id="Damage_Mod"></td>
        </tr>
      </table>
      <table>
        <tr>
          <td>Mastery: </td>
          <td id="Mastery_Base"></td>
        </tr>
        <tr>
          <td>Mod:</td>
          <td id="Mastery_Mod"></td>
        </tr>
      </table>
      <table>
        <tr>
          <td>Speed:</td>
          <td id="Speed_Base"></td>
        </tr>
        <tr>
          <td>Mod:</td>
          <td id="Speed_Mod"></td>
        </tr>
      </table>
    </div>

    <h2>Archetype: Deadeye</h2>
    <div class="cards2">
      
      <table>
        <tr>
          <td>Accuracy: </td>
          <td class="Accuracy">4</td>
        </tr>
      </table>
      
      <table>
        <tr>
          <td>Damage: </td>
          <td class="Damage">1</td>
        </tr>
      </table>
      
      <table>
        <tr>
          <td>Mastery: </td>
          <td class="Mastery">2</td>
        </tr>
      </table>
      
      <table>
        <tr>
          <td>Speed: </td>
          <td class="Speed">0</td>
        </tr>
      </table>
      
    </div>

    <h2>Class: Hunter</h2>
    <div class="cards2">
      
      <table>
        <tr>
          <td>Accuracy:</td>
          <td class="Accuracy">2</td>
        </tr>
      </table>
      
      <table>
        <tr>
          <td>Damage:</td>
          <td class="Damage">1</td>
        </tr>
      </table>
      
      <table>
        <tr>
          <td>Mastery:</td>
          <td class="Mastery">1</td>
        </tr>
      </table>
      
      <table>
        <tr>
          <td>Speed:</td>
          <td class="Speed">0</td>
        </tr>
      </table>
      
    </div>

    <h2>Background: Prize Shot</h2>
    <div class="cards2">
      
      <table>
        <tr>
          <td>Accuracy:</td>
          <td class="Accuracy">1</td>
        </tr>
      </table>
      
      <table>
        <tr>
          <td>Insight_Checks:</td>
          <td class="Insight_Checks">-2</td>
        </tr>
      </table>
      
    </div>

    <h2>Skill Tree</h2>
    <div class="cards3">
      
      <table>
        <tr>
          <td colspan="2">
            Caliber 1
          </td>
        </tr>
        
        <tr>
          <td>Damage_Mod_Favored</td>
          <td class="Damage_Mod_Favored">1</td>
        </tr>
        
        <tr>
          <td>Search_Checks</td>
          <td class="Search_Checks">1</td>
        </tr>
        
      </table>
      
    </div>

    <h2>Action Skill</h2>
    <div>Wings Of Blood!</div>
    <div>TODO: Add tickmarks for single use in combat and number per day equaly to mastery mod</div>

    <h2>Favored Gun</h2>
    <div id="Favored_Gun_Type">Sniper</div>

    <h2>Melee Die</h2>
    <div>1D4</div>

    <h2>Traits</h2>
    <div>Insider: +5 Guild Sneak Checks</div>
    <div>Looter: +5 Loot Search Checks</div>

    <table>
      <tr>
        <td>Shield Type:</td>
        <td></td>
      </tr>
      <tr>
        <td>Shield Info:</td>
        <td></td>
      </tr>
    </table>

  </main>

</body>

</html>